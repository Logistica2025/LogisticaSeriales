     <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti贸n de Etiquetas de Seriales</title>
    
    <style>
        /* --- CSS INCORPORADO --- */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Alinea al inicio verticalmente */
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .main-container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px; /* Ancho m谩ximo para contener ambas secciones */
            display: flex;
            flex-direction: column; /* Cambia a columna para las pesta帽as */
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 25px;
        }

        /* Estilos de las pesta帽as */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .tab-button {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 16px;
            color: #555;
            transition: color 0.3s ease, border-bottom 0.3s ease;
        }

        .tab-button.active {
            color: #007bff;
            border-bottom: 2px solid #007bff;
            font-weight: bold;
        }

        .tab-content {
            display: none; /* Oculta el contenido de las pesta帽as por defecto */
            padding-top: 15px;
        }

        .tab-content.active {
            display: block; /* Muestra el contenido de la pesta帽a activa */
        }

        /* Contenedor del formulario y resultados */
        .form-section, .search-section {
            display: flex;
            gap: 20px; /* Espacio entre el formulario y el 谩rea de etiquetas */
            flex-wrap: wrap; /* Permite que los elementos se envuelvan en pantallas peque帽as */
        }

        .form-column {
            flex: 1; /* Ocupa el espacio disponible */
            min-width: 300px; /* Ancho m铆nimo para la columna del formulario */
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
        }

        input[type="number"],
        input[type="text"],
        select,
        textarea {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }

        input[type="text"][readonly],
        textarea[readonly] {
            background-color: #e9e9e9;
            color: #777;
            cursor: not-allowed;
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px; /* Ajustado para botones multiples */
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #0056b3;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        /* Estilos para el 谩rea de previsualizaci贸n de etiquetas */
        .label-preview-column {
            flex: 1; /* Ocupa el espacio disponible */
            min-width: 350px; /* Ancho m铆nimo para la columna de previsualizaci贸n */
            border: 1px dashed #ccc;
            padding: 15px;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        .label-preview-column h3 {
            text-align: center;
            color: #333;
            margin-top: 0;
            margin-bottom: 15px;
        }

        .label-container {
            width: 50mm; /* Ancho de la etiqueta */
            height: 30mm; /* Alto de la etiqueta */
            border: 1px solid #ddd;
            margin: 5px auto; /* Centrar y espaciar */
            box-sizing: border-box;
            padding: 2mm; /* Peque帽o padding dentro de la etiqueta */
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Espacia el contenido verticalmente */
            align-items: center; /* Centra horizontalmente */
            overflow: hidden; /* Evita que el contenido se salga */
            background-color: white;
            font-size: 8px; /* Tama帽o de fuente base para la etiqueta */
            page-break-after: always; /* Para la impresi贸n, cada etiqueta en una nueva p谩gina */
        }

        .label-container p, .label-container h4, .label-container h5 {
            margin: 0;
            padding: 0;
            text-align: center;
            line-height: 1; /* Ajustar el interlineado */
        }

        .label-container h4 {
            font-size: 10px; /* C贸digo */
            font-weight: bold;
        }
        .label-container h5 {
            font-size: 7px; /* Descripci贸n */
            margin-bottom: 1mm;
        }
        .label-container .barcode-svg {
            width: 90%; /* Ajustar el ancho del c贸digo de barras */
            height: 12mm; /* Ajustar la altura del c贸digo de barras */
            margin: 1mm 0;
        }
        .label-container .serial-text {
            font-size: 9px; /* Serial */
            font-weight: bold;
            margin-top: 1mm;
        }

        #generatedSerialsList {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        #generatedSerialsList h4 {
            margin-top: 0;
            color: #333;
        }

        #serialsOutput {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            background-color: #f0f0f0;
            font-family: monospace;
            white-space: pre-wrap; /* Mantiene saltos de l铆nea */
            font-size: 14px;
        }

        /* Estilos para la secci贸n de b煤squeda */
        #searchResultList {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 15px;
        }

        .search-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            background-color: #fff;
        }

        .search-item:last-child {
            border-bottom: none;
        }

        .search-item-details {
            flex-grow: 1;
        }

        .search-item-details strong {
            display: block;
            font-size: 1.1em;
            color: #333;
        }

        .search-item-details span {
            font-size: 0.9em;
            color: #666;
        }

        .search-item-actions button {
            width: auto;
            padding: 5px 10px;
            font-size: 14px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1>Gesti贸n de Etiquetas de Seriales</h1>

        <div class="tabs">
            <button class="tab-button active" data-tab="generate">Generar Etiquetas</button>
            <button class="tab-button" data-tab="search">Buscar/Reimprimir Seriales</button>
        </div>

        <div id="generate" class="tab-content active">
            <div class="form-section">
                <div class="form-column">
                    <form id="materialForm">
                        <div class="form-group">
                            <label for="nomenclatura">Nomenclatura (0,1,2,3,5):</label>
                            <select id="nomenclatura" name="nomenclatura" required>
                                <option value="">Selecciona</option>
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="5">5</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="codigo">C贸digo (1-5 d铆gitos):</label>
                            <input type="number" id="codigo" name="codigo" min="0" max="99999" required>
                        </div>

                        <div class="form-group">
                            <label for="material">Material:</label>
                            <input type="text" id="material" name="material" readonly>
                        </div>

                        <div class="form-group">
                            <label for="descripcion">Descripci贸n:</label>
                            <textarea id="descripcion" name="descripcion" rows="3" readonly></textarea>
                        </div>

                        <div class="form-group">
                            <label for="um">Unidad de Medida (UM):</label>
                            <input type="text" id="um" name="um" readonly>
                        </div>

                        <h3>Opciones de Seriales:</h3>
                        <div class="form-group">
                            <label for="serialManual">Serial Individual:</label>
                            <input type="text" id="serialManual" name="serialManual" placeholder="Ej: NS270520250001">
                        </div>

                        <div class="form-group">
                            <label for="serialesPegados">Pegar Seriales (uno por l铆nea):</label>
                            <textarea id="serialesPegados" name="serialesPegados" rows="4" placeholder="Serial1&#10;Serial2&#10;Serial3"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="correlativoInicio">Serial Correlativo (Inicio):</label>
                            <input type="text" id="correlativoInicio" name="correlativoInicio" placeholder="Ej: NS270520250001">
                        </div>
                        <div class="form-group">
                            <label for="correlativoCantidad">Cantidad de Correlativos:</label>
                            <input type="number" id="correlativoCantidad" name="correlativoCantidad" min="1" value="1">
                        </div>

                        <div class="button-group">
                            <button type="button" id="generateAndSaveButton">Generar y Guardar</button>
                            <button type="button" id="generateAndPrintButton">Generar e Imprimir</button>
                        </div>
                    </form>
                </div>

                <div class="label-preview-column">
                    <h3>Previsualizaci贸n de Etiquetas</h3>
                    <div id="labelsPreviewContainer">
                        </div>
                </div>
            </div>

            <div id="generatedSerialsList">
                <h4>Seriales Generados en Sesi贸n:</h4>
                <div id="serialsOutput">
                    </div>
            </div>
        </div>

        <div id="search" class="tab-content">
            <div class="search-section">
                <div class="form-column">
                    <h3>Buscar Seriales Registrados</h3>
                    <div class="form-group">
                        <label for="searchSerialInput">Buscar por Serial (o parte de 茅l):</label>
                        <input type="text" id="searchSerialInput" placeholder="Ej: NS27052025">
                    </div>
                    <div class="form-group">
                        <label for="searchMaterialInput">Buscar por Material:</label>
                        <input type="text" id="searchMaterialInput" placeholder="Ej: 1000000001">
                    </div>
                    <button type="button" id="searchButton">Buscar Seriales</button>
                </div>
                <div class="label-preview-column">
                    <h3>Resultados de B煤squeda</h3>
                    <div id="searchResultList">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        // --- JAVASCRIPT INCORPORADO ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- Referencias del DOM para la secci贸n de Generaci贸n ---
            const nomenclaturaInput = document.getElementById('nomenclatura');
            const codigoInput = document.getElementById('codigo');
            const materialInput = document.getElementById('material');
            const descripcionInput = document.getElementById('descripcion');
            const umInput = document.getElementById('um');
            const serialManualInput = document.getElementById('serialManual');
            const serialesPegadosInput = document.getElementById('serialesPegados');
            const correlativoInicioInput = document.getElementById('correlativoInicio');
            const correlativoCantidadInput = document.getElementById('correlativoCantidad');
            const generateAndSaveButton = document.getElementById('generateAndSaveButton');
            const generateAndPrintButton = document.getElementById('generateAndPrintButton');
            const labelsPreviewContainer = document.getElementById('labelsPreviewContainer');
            const serialsOutput = document.getElementById('serialsOutput'); // Para mostrar seriales generados en sesi贸n

            // --- Referencias del DOM para la secci贸n de B煤squeda ---
            const searchSerialInput = document.getElementById('searchSerialInput');
            const searchMaterialInput = document.getElementById('searchMaterialInput');
            const searchButton = document.getElementById('searchButton');
            const searchResultList = document.getElementById('searchResultList');

            // --- Referencias de las Pesta帽as ---
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            // --- URLs de Google Apps Script (隆ACTUALIZA ESTAS!) ---
            // Usa la URL de tu despliegue webapp para las llamadas a Apps Script
             const GOOGLE_APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzNdIYoIO_zV8ri0tx7za0slaCdIyWGqMiPrtxWgAkAu3XE9ddaKzKkTuhV9rKNWYunWg/exec'; 

    
            let generatedSerialsInSession = []; // Array para guardar los seriales generados en la sesi贸n actual

            // --- Funciones de Utilidad ---

            // Funci贸n para calcular y actualizar el campo Material
            const updateMaterial = () => {
                const nomenclatura = parseInt(nomenclaturaInput.value, 10);
                const codigo = parseInt(codigoInput.value, 10);

                if (!isNaN(nomenclatura) && nomenclaturaInput.value !== "" && 
                    !isNaN(codigo) && codigoInput.value !== "" && codigo >= 1 && codigo <= 99999) { // C贸digo entre 1 y 5 d铆gitos
                    
                    const materialCalculado = (nomenclatura * 1000000000) + codigo;
                    materialInput.value = String(materialCalculado);
                } else {
                    materialInput.value = ''; // Limpiar si los campos no son v谩lidos o est谩n vac铆os
                }
                buscarDatosMaterial();
                buscarUltimoSerial(); // Buscar el 煤ltimo serial generado para este material
            };

            // Funci贸n para buscar Descripci贸n y UM en Google Sheets
            const buscarDatosMaterial = async () => {
                const materialABuscar = materialInput.value;
                
                descripcionInput.value = 'Buscando...';
                umInput.value = 'Buscando...';
                
                // Si no hay material para buscar o la URL no es v谩lida
                if (!materialABuscar || GOOGLE_APPS_SCRIPT_WEB_APP_URL === '') { // THIS IS A PLACEHOLDER
                    descripcionInput.value = '';
                    umInput.value = '';
                    return;
                }

                try {
                    const response = await fetch(`${GOOGLE_APPS_SCRIPT_WEB_APP_URL}?action=searchMaterial&material=${encodeURIComponent(materialABuscar)}`);
                    
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }

                    const data = await response.json();

                    if (data && data.descripcion) {
                        descripcionInput.value = data.descripcion;
                        umInput.value = data.um || 'N/A';
                    } else {
                        descripcionInput.value = 'Descripci贸n no encontrada.';
                        umInput.value = 'UM no encontrada.';
                    }
                } catch (error) {
                    console.error('Error al buscar datos del material:', error);
                    descripcionInput.value = 'Error al cargar la descripci贸n.';
                    umInput.value = 'Error al cargar UM.';
                }
            };

            // Funci贸n para buscar el 煤ltimo serial registrado para el Material actual
            const buscarUltimoSerial = async () => {
                const materialABuscar = materialInput.value;
                serialManualInput.placeholder = 'Cargando 煤ltimo serial...';

                if (!materialABuscar || GOOGLE_APPS_SCRIPT_WEB_APP_URL === '') { // THIS IS A PLACEHOLDER
                    serialManualInput.placeholder = 'Ej: NS270520250001';
                    return;
                }

                try {
                    const response = await fetch(`${GOOGLE_APPS_SCRIPT_WEB_APP_URL}?action=getLastSerial&material=${encodeURIComponent(materialABuscar)}`);
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                    const data = await response.json();
                    if (data && data.lastSerial) {
                        serialManualInput.value = data.lastSerial;
                        serialManualInput.placeholder = `ltimo: ${data.lastSerial}`;
                    } else {
                        serialManualInput.value = '';
                        serialManualInput.placeholder = 'Ej: NS270520250001'; // O ning煤n serial previo
                    }
                } catch (error) {
                    console.error('Error al buscar 煤ltimo serial:', error);
                    serialManualInput.value = '';
                    serialManualInput.placeholder = 'Error al cargar 煤ltimo serial.';
                }
            };


            // Funci贸n para generar una 煤nica etiqueta HTML
            const createLabelHtml = (material, descripcion, um, serial) => {
                const labelDiv = document.createElement('div');
                labelDiv.className = 'label-container';
                labelDiv.innerHTML = `
                    <h4>${material}</h4>
                    <h5>${descripcion}</h5>
                    <svg class="barcode-svg" data-serial="${serial}"></svg>
                    <p class="serial-text">${serial}</p>
                `;
                return labelDiv;
            };

            // Funci贸n para renderizar el c贸digo de barras en un SVG
            const renderBarcodeSvg = (svgElement, serialValue) => {
                try {
                    JsBarcode(svgElement, serialValue, {
                        format: "CODE128",
                        displayValue: false, // No mostrar el texto del serial debajo del c贸digo
                        lineColor: "#000",
                        width: 2,
                        height: 50,
                        margin: 0, // Sin m谩rgenes adicionales
                        background: "#fff"
                    });
                } catch (e) {
                    console.error("Error al generar el c贸digo de barras para serial:", serialValue, e);
                    svgElement.innerHTML = `<p style="color: red; font-size: 7px; text-align: center;">Error BC: ${serialValue}</p>`;
                }
            };

            // Funci贸n principal para generar seriales y previsualizar etiquetas
            const generarSerialesYEtiquetas = () => {
                const material = materialInput.value;
                const descripcion = descripcionInput.value;
                const um = umInput.value;

                // Validar que Material, Descripci贸n y UM est茅n cargados
                if (!material || !descripcion || !um || 
                    descripcion.includes('Buscando') || descripcion.includes('Error')) {
                    alert('Por favor, aseg煤rate de que el Material, Descripci贸n y UM est茅n cargados correctamente antes de generar seriales.');
                    return [];
                }

                labelsPreviewContainer.innerHTML = ''; // Limpiar previsualizaci贸n anterior
                const serialsToProcess = [];
                generatedSerialsInSession = []; // Limpiar la lista de seriales generados en sesi贸n

                // 1. Serial Individual
                const serialManual = serialManualInput.value.trim();
                if (serialManual) {
                    serialsToProcess.push(serialManual);
                }

                // 2. Seriales Pegados
                const serialesPegados = serialesPegadosInput.value.trim();
                if (serialesPegados) {
                    const parsedSerials = serialesPegados.split('\n').map(s => s.trim()).filter(s => s !== '');
                    serialsToProcess.push(...parsedSerials);
                }

                // 3. Seriales Correlativos
                const correlativoInicio = correlativoInicioInput.value.trim();
                const correlativoCantidad = parseInt(correlativoCantidadInput.value, 10);

                if (correlativoInicio && correlativoCantidad > 0) {
                    // L贸gica para extraer la parte num茅rica final y el prefijo/sufijo
                    const match = correlativoInicio.match(/^(.*?)([0-9]+)([^0-9]*)$/);
                    if (match) {
                        const prefix = match[1];
                        let startNumber = parseInt(match[2], 10);
                        const numDigits = match[2].length;
                        const suffix = match[3];

                        for (let i = 0; i < correlativoCantidad; i++) {
                            const currentNumber = (startNumber + i).toString().padStart(numDigits, '0');
                            serialsToProcess.push(`${prefix}${currentNumber}${suffix}`);
                        }
                    } else {
                        alert('El serial inicial para el correlativo no tiene un patr贸n num茅rico reconocible. Por favor, aseg煤rate de que termine con n煤meros (ej. NS270520250001).');
                        // Retornar [] para evitar procesar seriales incorrectos
                        return []; 
                    }
                }

                if (serialsToProcess.length === 0) {
                    alert('No se ha introducido ning煤n serial para generar. Por favor, usa una de las opciones.');
                    return [];
                }

                // Eliminar duplicados si es necesario (opcional, dependiendo de la l贸gica de negocio)
                const uniqueSerials = [...new Set(serialsToProcess)];

                // Generar previsualizaci贸n y registrar para la sesi贸n
                uniqueSerials.forEach(serial => {
                    const labelHtml = createLabelHtml(material, descripcion, um, serial);
                    labelsPreviewContainer.appendChild(labelHtml);
                    generatedSerialsInSession.push({
                        material: material,
                        descripcion: descripcion,
                        um: um,
                        serial: serial
                    });
                });

                // Renderizar todos los c贸digos de barras despu茅s de que los SVG est茅n en el DOM
                labelsPreviewContainer.querySelectorAll('.barcode-svg').forEach(svg => {
                    renderBarcodeSvg(svg, svg.dataset.serial);
                });

                // Mostrar seriales generados en el 谩rea de texto
                serialsOutput.textContent = uniqueSerials.join('\n');

                return generatedSerialsInSession; // Retorna los seriales con sus datos completos
            };

            // Funci贸n para enviar datos a la hoja de "Registros" (ahora maneja m煤ltiples seriales)
            const enviarDatosARegistros = async (serialsToRegister) => {
                if (serialsToRegister.length === 0) {
                   alert('No hay seriales para registrar.');
                   return false;
                }

                // Validaciones adicionales antes de enviar (por si algo cambi贸 desde la generaci贸n)
                const material = materialInput.value;
                const descripcion = descripcionInput.value;
                const um = umInput.value;

                if (!material || !descripcion || !um || 
                    descripcion.includes('Buscando') || descripcion.includes('Error')) {
                    alert('Faltan datos de Material, Descripci贸n o UM para registrar. Vuelve a cargar la informaci贸n.');
                    return false;
                }
                
                // Asegurarse de que cada objeto en serialsToRegister tenga todos los campos
                const completeData = serialsToRegister.map(s => ({
                    material: s.material, // Asegurarse de usar los datos del objeto completo
                    descripcion: s.descripcion,
                    um: s.um,
                    serial: s.serial 
                }));

                // console.log("Datos a enviar al Apps Script:", JSON.stringify({ action: 'registerSerials', data: completeData })); // Depuraci贸n

                generateAndSaveButton.disabled = true;
                generateAndPrintButton.disabled = true;
                generateAndSaveButton.textContent = 'Enviando...';
                generateAndPrintButton.textContent = 'Enviando...';

               try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
          'Accept': 'application/json'
        },
                        body: JSON.stringify({ action: 'registerSerials', data: completeData }) // Enviar un array de objetos
                    });

                  if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);

                    const result = await response.json();

                    if (result.success) {
                        alert('隆Datos registrados exitosamente en la hoja de Registros!');
                        return true;
                    } else {
                        alert('Error al registrar los datos: ' + result.message);
                        return false;
                    }
                } catch (error) {
                    console.error('Error al enviar datos:', error);
                    alert('Hubo un problema al conectar con el servidor para registrar los datos. Intenta de nuevo m谩s tarde. Detalles: ' + error.message);
                    return false;
                } finally {
                    generateAndSaveButton.disabled = false;
                    generateAndPrintButton.disabled = false;
                    generateAndSaveButton.textContent = 'Generar y Guardar';
                    generateAndPrintButton.textContent = 'Generar e Imprimir';
                }
            };

            const generarEImprimirPDF = async (serialsData) => {
    if (serialsData.length === 0) {
        alert('No hay seriales para imprimir.');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: [50, 30]
    });

    const addSvgToPdf = (doc, svgElement, x, y, width, height) => {
        const serializer = new XMLSerializer();
        const svgString = serializer.serializeToString(svgElement);
        return new Promise((resolve) => {
            doc.addImage(
                `data:image/svg+xml;base64,${btoa(svgString)}`,
                'SVG',
                x,
                y,
                width,
                height,
                '',
                'FAST'
            );
            resolve();
        });
    };

    for (let i = 0; i < serialsData.length; i++) {
        const item = serialsData[i];

        const tempDiv = document.createElement('div');
        tempDiv.style.cssText = 'position: absolute; left: -9999px; top: -9999px; width: 1px; height: 1px; overflow: hidden;';
        const tempSvg = document.createElement('svg');
        tempSvg.dataset.serial = item.serial;
        tempDiv.appendChild(tempSvg);
        document.body.appendChild(tempDiv);

        renderBarcodeSvg(tempSvg, item.serial);

        if (i > 0) {
            doc.addPage();
        }

        const page_width = doc.internal.pageSize.getWidth();
        const page_height = doc.internal.pageSize.getHeight();

        doc.setFontSize(10);
        doc.text(`Material: ${item.material}`, page_width / 2, 4, { align: 'center' });

        doc.setFontSize(7);
        doc.text(item.descripcion, page_width / 2, 8, { align: 'center' });

        const barcode_width_mm = 40;
        const barcode_height_mm = 12;
        const barcode_x = (page_width - barcode_width_mm) / 2;
        const barcode_y = 10;

        await addSvgToPdf(doc, tempSvg, barcode_x, barcode_y, barcode_width_mm, barcode_height_mm);

        doc.setFontSize(9);
        doc.text(item.serial, page_width / 2, 26, { align: 'center' });

        document.body.removeChild(tempDiv);
    }

    //  NUEVO: Usar Blob para abrir el PDF e imprimir autom谩ticamente
    try {
        const blob = doc.output('blob');
        const blobUrl = URL.createObjectURL(blob);

        const printWindow = window.open(blobUrl, '_blank');

        if (printWindow) {
            printWindow.onload = () => {
                printWindow.focus();
                printWindow.print();
            };
        } else {
            alert("El navegador bloque贸 la ventana emergente. Por favor, permite las ventanas emergentes para esta p谩gina.");
        }
    } catch (e) {
        console.error("Error al abrir la ventana de impresi贸n/PDF:", e);
        alert("El navegador bloque贸 la ventana de impresi贸n. Por favor, revisa la configuraci贸n de ventanas emergentes o int茅ntalo de nuevo.");
    }
};
            
            // Funci贸n para limpiar el formulario despu茅s de generar/imprimir
            const resetForm = () => {
                nomenclaturaInput.value = '';
                codigoInput.value = '';
                materialInput.value = '';
                descripcionInput.value = '';
                umInput.value = '';
                serialManualInput.value = '';
                serialesPegadosInput.value = '';
                correlativoInicioInput.value = '';
                correlativoCantidadInput.value = '1';
                labelsPreviewContainer.innerHTML = '';
                serialsOutput.textContent = '';
                generatedSerialsInSession = []; // Limpiar los seriales en sesi贸n
                updateMaterial(); // Llama para limpiar estados iniciales
            };

            // --- Event Listeners para la secci贸n de Generaci贸n ---
            nomenclaturaInput.addEventListener('change', updateMaterial);
            codigoInput.addEventListener('input', updateMaterial);
            
            // Re-generar vista previa de etiquetas cuando cambian los seriales
            serialManualInput.addEventListener('input', generarSerialesYEtiquetas);
            serialesPegadosInput.addEventListener('input', generarSerialesYEtiquetas);
            correlativoInicioInput.addEventListener('input', generarSerialesYEtiquetas);
            correlativoCantidadInput.addEventListener('input', generarSerialesYEtiquetas);


            generateAndSaveButton.addEventListener('click', async () => {
                const serials = generarSerialesYEtiquetas();
                if (serials.length > 0) {
                    const success = await enviarDatosARegistros(serials);
                    if (success) {
                        resetForm(); // Resetear si se guard贸 correctamente
                    }
                }
            });

            generateAndPrintButton.addEventListener('click', async () => {
                const serials = generarSerialesYEtiquetas();
                if (serials.length > 0) {
                    const success = await enviarDatosARegistros(serials);
                    if (success) {
                        await generarEImprimirPDF(serials); // Imprimir solo si se guard贸
                        resetForm(); // Resetear despu茅s de guardar e imprimir
                    }
                }
            });

            // --- Event Listeners para la gesti贸n de Pesta帽as ---
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));

                    button.classList.add('active');
                    document.getElementById(button.dataset.tab).classList.add('active');
                    
                    // Limpiar campos de b煤squeda al cambiar a pesta帽a de generaci贸n
                    if (button.dataset.tab === 'generate') {
                        searchSerialInput.value = '';
                        searchMaterialInput.value = '';
                        searchResultList.innerHTML = '';
                    } else if (button.dataset.tab === 'search') {
                        // Opcional: Limpiar campos de generaci贸n al cambiar a b煤squeda
                        resetForm(); 
                    }
                });
            });

            // --- Funcionalidad de B煤squeda (Parte 2, la implementaremos en el pr贸ximo paso) ---
            searchButton.addEventListener('click', async () => {
                alert('La funcionalidad de b煤squeda y reimpresi贸n se implementar谩 en el siguiente paso.');
                // Aqu铆 ir谩 la l贸gica para buscar y mostrar los seriales registrados
            });


            // --- Inicializaci贸n al cargar la p谩gina ---
            updateMaterial(); // Cargar estado inicial y autocompletar si es posible
            // Se asume que la pesta帽a "Generar Etiquetas" es la activa por defecto
        });
    </script>
</body>
</html>
